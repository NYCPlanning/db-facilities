name: Build

on:
  push:
    paths-ignore:
      - "*.md"
      - ".pre-commit-config.yml"
      - ".gitignore"
      - "docs/*"
  workflow_dispatch:

jobs:
  Build:
    name: Building ...
    runs-on: ubuntu-20.04
    steps:
        - uses: actions/checkout@v2

        # Pull the latest image to build, and avoid caching pull-only images.
        # (docker pull is faster than caching in most cases.)
        - run: docker-compose pull

        # In this step, this action saves a list of existing images,
        # the cache is created without them in the post run.
        # It also restores the cache if it exists.
        - uses: satackey/action-docker-layer-caching@v0.0.11
          # Ignore the failure of a step and avoid terminating the job.
          continue-on-error: true

        - name: Initialize
          run: ./facdb.sh init

        - name: Cache Large Files (PLUTO & Building Footprints)
          uses: actions/cache@v2
          id: dataloading
          with:
            path: .library
            key: dataloading-${{ hashFiles('facdb/bash/dataloading.sh') }}

        - name: Dataloading
          if: steps.dataloading.outputs.cache-hit != 'true'
          run: ./facdb.sh dataloading

        - name: Check on Services
          run: docker-compose ps

        - name: Run Pipeliens
          run: ./facdb.sh run --all
